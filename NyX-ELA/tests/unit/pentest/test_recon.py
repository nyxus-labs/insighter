import pytest

from nyx_ela.core.exceptions import AuthorizationError
from nyx_ela.modules.terminal import TerminalModule
from nyx_ela.pentest.pentest_engine import EngagementContext, PentestEngine


def test_pentest_engine_requires_authorization():
    engine = PentestEngine(TerminalModule(dry_run=True))
    context = EngagementContext(target="example.internal", scope="internal")

    with pytest.raises(AuthorizationError):
        engine.run_authorized_check(context, "baseline")


def test_pentest_engine_authorized_dry_run():
    engine = PentestEngine(TerminalModule(dry_run=True))
    context = EngagementContext(target="example.internal", scope="internal", authorized=True)

    output = engine.run_authorized_check(context, "baseline")
    assert "[dry-run]" in output
