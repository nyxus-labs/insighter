"""Authorized red-team orchestration planner.

This module only produces and executes high-level, authorized engagement plans.
"""

from __future__ import annotations

from dataclasses import dataclass

from nyx_ela.core.exceptions import AuthorizationError
from nyx_ela.modules.terminal import TerminalModule


@dataclass(slots=True)
class EngagementContext:
    target: str
    scope: str
    authorized: bool = False


class PentestEngine:
    def __init__(self, terminal: TerminalModule) -> None:
        self.terminal = terminal

    def build_plan(self, objective: str) -> list[str]:
        objective = objective.lower()
        if "recon" in objective or "osint" in objective:
            return ["collect passive asset inventory", "run DNS and certificate visibility checks", "compile findings"]
        if "scan" in objective:
            return ["identify approved hosts", "perform service discovery", "prioritize exposed services"]
        if "report" in objective:
            return ["summarize findings", "map to risk severity", "recommend remediations"]
        return ["clarify objective", "prepare authorized workflow", "record outcomes"]

    def run_authorized_check(self, context: EngagementContext, check_name: str) -> str:
        if not context.authorized:
            raise AuthorizationError("Engagement context must be explicitly authorized.")
        result = self.terminal.execute(f"echo running {check_name} against {context.target} in {context.scope}")
        return result.output
